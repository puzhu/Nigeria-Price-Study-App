<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<head>
<script src="libraries/d3.v3.min.js"></script>
<script src="libraries/topojson.v1.min.js"></script>
<script src="libraries/queue.v1.min.js"></script>
<style>

</style>
</head>
<body>

<div id="main">
	<div id="volChart"></div>
</div>

</body>
<script>
//Constructed Functions and variables for the cade
function uniq_fast(a) { // quickly drop duplicate values from an array
      var seen = {};
      var out = [];
      var len = a.length;
      var j = 0;
      for(var i = 0; i < len; i++) {
           var item = a[i];
           if(seen[item] !== 1) {
                 seen[item] = 1;
                 out[j++] = item;
           }
      }
      return out;
  }
var monthYear = d3.time.format("%b %y"); //converts to Month-Year
var monthFormat = d3.time.format("%Y-%m").parse; //Parse dates and converts to a d3 time format

//queing the data file
queue()
  .defer(d3.json, "data/volatility.json")
  .defer(d3.json, "data/zones.json")
  .defer(d3.json, "data/zoneStates.json")
  .await(ready);
//creating the function ready
function ready(error, volatility, zones, zoneStates){
  console.log(zoneStates)
  var input = "Cement Dangote" //This would be the input value based on user input

  //Loading the data and creating domain and data variables
  var data = volatility.filter(function(d) { return d.item === input }); //loading the volatility data based on input
  var zoneData = zones.filter(function(d) { return d.item === input }); //loading the zones data based on the input

  var yChartDomain = uniq_fast(zoneData.map(function(d){return d.zoneCode})); //the height of the chart is set to the zones
  var xChartDomain = uniq_fast(zoneData.map(function(d){return monthFormat(d.date.slice(0,7))})).sort(function(a,b) { return a - b;});//the width of chart is based on the number of dates.
  var xPanelDomain = d3.extent(data, function(d){return d.volMoving}); // the width of each panel is set to the range of volatility for the selected input
  var yPanelDomain = uniq_fast(zoneData.map(function(d){return d.countStates})).sort(function(a,b) { return a - b;});//the height of each panel is set to the range of the states count within zones
  var colorDomain = d3.extent(data, function(d){return d.volMoving})


  //Creating the canvas
  var containerSize = {'height': 600, 'width': 1000}
  var margin = {top: 0.02 * containerSize.height , right: 0.01 * containerSize.width, bottom: 0.02 * containerSize.height, left: 0.04 * containerSize.width}
  var padding = {top: 0.06 * containerSize.height, right: 0.06 * containerSize.width, bottom: 0.06 * containerSize.height, left: 0.06 * containerSize.width}
  var chartSize = {'height': containerSize.height - margin.top - margin.bottom, 'width': containerSize.width - margin.right - margin.bottom}
  var width = chartSize.width - padding.left - padding.right
  var height = chartSize.height - padding.top - padding.bottom

  var volChart = d3.select('#volChart').append('svg') //http://bl.ocks.org/mbostock/3019563
        .attr({
          height: containerSize.height,
          width: containerSize.width
        })
      .append('g')
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var yChartScale = d3.scale.ordinal()
      .domain(yChartDomain)
      .rangeRoundBands([0, height], 0.05);

  var xChartScale = d3.scale.ordinal()
      .domain(xChartDomain)
      .rangeRoundBands([0, width], 0.05)

  var panelPadding = {top: 0.02 * containerSize.height, right: 0.01 * containerSize.width, bottom: 0.02 * containerSize.height, left: 0.01 * containerSize.width}
  var panelSize = {'height': yChartScale.rangeBand() - panelPadding.top - panelPadding.bottom, 'width': xChartScale.rangeBand() - panelPadding.right - panelPadding.left}

  var yPanelScale = d3.scale.ordinal()
      .domain(yPanelDomain)
      .rangeBands([0, panelSize.height], 0.2)


  var xPanelScale = d3.scale.linear()
      .domain(xPanelDomain)
      .range([panelPadding.left, panelSize.width])

  var colorScales = d3.scale.linear() //could change the scale later
        .domain(colorDomain) //based on the maximum volatility value in the data (better than just binning)
        .range(["#0000ff","#ff0000"])
        .interpolate(d3.interpolateHcl);

  //Drawing the chart
 /* volChart.append('g')
      .selectAll(".hlines") //Horizontal grid lines
      .data(yChartDomain)
      .enter()
      .append('line')
      .attr({
        x1: 0,
        y1: function(d){return yChartScale(d)},
        x2: width,
        y2: function(d){return yChartScale(d)}
      })
      .style("stroke", "#9e9e9e");
  volChart.append('g') //vertical grid lines
      .selectAll(".vlines")
      .data(xChartDomain)
      .enter()
      .append('line')
      .attr({
        x1: function(d){return xChartScale(d)},
        y1: 0,
        x2: function(d){return xChartScale(d)},
        y2: height
      })
      .style("stroke", "#9e9e9e"); */

  volChart.append('g') //the first line in the box
      .selectAll(".boxLines")
      .data(zoneData)
      .enter()
      .append('line')
      .attr({
        x1: function(d){return xPanelScale(d.fQ) + xChartScale(d.date)},
        y1: function(d) {return yChartScale(d.zoneCode)},
        x2: function(d){return xPanelScale(d.fQ) + xChartScale(d.date)},
        y2: function(d){return yPanelScale(d.maxStates) + yChartScale(d.zoneCode)}
      })
      .style("stroke", "#9e9e9e")
      //.style("stroke-dasharray", ("3, 3")) 

  volChart.append('g') //last line in the box
      .selectAll(".boxLines")
      .data(zoneData)
      .enter()
      .append('line')
      .attr({
        x1: function(d){return xPanelScale(d.tQ) + xChartScale(d.date)},
        y1: function(d) {return yChartScale(d.zoneCode)},
        x2: function(d){return xPanelScale(d.tQ) + xChartScale(d.date)},
        y2: function(d){return yPanelScale(d.maxStates) + yChartScale(d.zoneCode)}
      })
      .style("stroke", "#9e9e9e")
      //.style("stroke-dasharray", ("3, 3"))

  volChart.append('g') //median
      .selectAll(".boxLines")
      .data(zoneData)
      .enter()
      .append('line')
      .attr({
        x1: function(d){return xPanelScale(d.median) + xChartScale(d.date)},
        y1: function(d) {return yChartScale(d.zoneCode)},
        x2: function(d){return xPanelScale(d.median) + xChartScale(d.date)},
        y2: function(d){return yPanelScale(d.maxStates) + yChartScale(d.zoneCode)}
      })
      .style("stroke", "#0000FF")
      .style("stroke-dasharray", ("2, 2"))

  volChart.append('g') //mean
      .selectAll(".boxLines")
      .data(zoneData)
      .enter()
      .append('line')
      .attr({
        x1: function(d){return xPanelScale(d.mean) + xChartScale(d.date)},
        y1: function(d) {return yChartScale(d.zoneCode)},
        x2: function(d){return xPanelScale(d.mean) + xChartScale(d.date)},
        y2: function(d){return yPanelScale(d.maxStates) + yChartScale(d.zoneCode)}
      })
      .style("stroke", "#C0C0C0")
      .style("stroke-dasharray", ("2, 2"))

  volChart.append('g') //the circles
      .selectAll('.dots')
      .data(data)
      .enter()
      .append('circle')
      .attr({
        r: 2,
        cx: function(d){return xChartScale(d.date) + xPanelScale(d.volMoving)},
        cy: function(d){return yChartScale(d.zoneCode) + yPanelScale(d.stateCode)}
      })
      .style({
          fill: function(d){return colorScales(d.volMoving)}
        });

  volChart.append('g')
      .attr('class', 'y-labels')
      .selectAll('text')
      .data(yChartDomain)
      .enter()
      .append('text')
      .text(function(d){return (d)})
      .attr({
        x: -20,
        y: function(d){return yChartScale(d) + panelSize.height/2}
      })
  volChart.append('g')
      .attr('class', 'x-labels')
      .selectAll('text')
      .data(xChartDomain)
      .enter()
      .append('text')
      .text(function(d){return monthYear(d)})
      .attr({
        x: function(d){return xChartScale(d) + panelSize.width/2},
        y: 0
      })
  volChart.append('g')
      .attr('class', "state-labels")
      .selectAll('text')
      .data(zoneStates)
      .enter()
      .append('text')
      .text(function(d){return d.state})
      .attr({
        x: -10,
        y: function(d){return yChartScale(d.zoneCode) + yPanelScale(d.stateCode)}
      })
      .style('font-size', 8)
}

</script>
</html>