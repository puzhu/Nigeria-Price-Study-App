
//Constructed Functions for the analysis
function uniq_fast(a) { // quickly drop duplicate values from an array
	    var seen = {};
	    var out = [];
	    var len = a.length;
	    var j = 0;
	    for(var i = 0; i < len; i++) {
	         var item = a[i];
	         if(seen[item] !== 1) {
	               seen[item] = 1;
	               out[j++] = item;
	         }
	    }
	    return out;
	}

//loading data and creating domain variables
var data = tributary.data;
//console.log(data)
var maxY = d3.max(data, function(d){return Math.ceil(d.position/2)}) //eventually should be calculated as the max value for each product for all of Nigeria to determine the size of the dot plot
var maxRank = d3.max(data, function(d){ return d.volatilityRank}) //this sets the x range for each chart and the color scale
var maxX  = uniq_fast(data.map(function(d){return d.state})).length // this sets the x range for the number of columns(states) in the panel

//creating a unique list of dates to sort the chart vertically
var monthYear = d3.time.format("%b %y") //these two time formats should ideally be one
var monthFormat = d3.time.format("%Y-%m").parse;
var allDates = uniq_fast(data.map(function(d){return monthFormat(d.date.slice(0,7))})).sort(function(a,b) { return a - b;})

//creating a unique list of states
var states = uniq_fast(data.map(function(d){return d.state}))
console.log(states[0])

//creating the canvas
var yPadding = 20;
var xPadding = 4;
var dotRadius = 2.5;
var yJitter = dotRadius * 2.4;
var xJitter = dotRadius * 2.4
var quintileJitter = 15;
var chartHeight = 1696;
var chartWidth = 1803;
var yFontSize = 12;
var xFontSize = 12;

var svg = d3.select('svg')
		.attr({
          width: chartWidth,
          height:chartHeight
        });

var colorScales = d3.scale.linear()
	.domain([1, maxRank])
    .range(["#0000ff","#ff0000"])
	.interpolate(d3.interpolateHcl)

var yRange = [yPadding + maxY*yJitter] //creating the range based on dot size
for (i = 1; i < allDates.length; i++){
	yRange.push(yRange[i-1] + yPadding + maxY*yJitter)
}
var yScale = d3.scale.ordinal()
		.domain(allDates)
		.range(yRange) //Should be eventually based on maxY(line 3)


var xRange = [80] //turn this to a variable based on the length of the date text + xPadding
for(i = 1; i < states.length; i++){
	xRange.push(xRange[i-1] + maxX*quintileJitter + quintileJitter*dotRadius + xJitter + xPadding)
}//figure out the xRange equation, the current one is a bit arbitrary
var xScale = d3.scale.ordinal() //this will be based on the number of states
		.domain(states)
		.range(xRange)

//Binding data and drawing the elements

var dateText = svg.append('g')
		.attr("class", "y-labels")
		.selectAll('text')
		.data(allDates)
		.enter()
		.append('text')
		.text(function(d) {return monthYear(d)})
		.attr({
          x: xPadding,
          y: function(d){return yScale(d)}
        })
		.style('font-size', yFontSize)

var stateText = svg.append('g')
		.attr("class", "x-labels")
		.selectAll('text')
		.data(states)
		.enter()
		.append('text')
		.text(function(d) {return d})
		.attr({
          x: function(d){return xScale(d) + (maxX * quintileJitter)/2},
          y: yPadding
        })
		.style('font-size', xFontSize)


var dots = svg.selectAll('circle')
		.data(data)
		.enter()
		.append('circle')
		.attr({
          r: dotRadius,
          cx: function(d,i){return xScale(d.state) + d.volatilityRank*quintileJitter + (d.column)*xJitter},//determined by the quintile rank and state aka base position
          cy: function(d,i) {return yScale(d.date) - (d.position1 * yJitter + d.position2 * yJitter)}// - (d.position1 * 8 + d.position2 * 8 + 100)} //determined by date and stack position
        })
		.style({
          fill: function(d){return colorScales(d.volatilityRank)} //determined by quintile rank
        })


var xGrid = svg.append('g')
		.attr("class", "x-grid")
		.selectAll('rect')
		.date(data)
		.enter()
		.append('rect')
		.attr({
          width: 1000,
          height: 10,
          x: 498,
          y: 159
        })


var base = svg.selectAll('rect')
		.data(data)
		.enter()
		.append('rect')
		.attr({
          width: 80,
          height: 0.4,
          x: 100,//function(d,i){return i*90 + 10},//determined by the number of states
          y: 254 //would eventually be a function of the number of unique dates
          });



